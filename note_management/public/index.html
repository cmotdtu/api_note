<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghi ChÃº Thá»i Gian Thá»±c</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        #input-pass {
            width: 300px;
            /* Äáº·t chiá»u rá»™ng nhá» hÆ¡n */
            margin: 100px auto;
            /* CÄƒn giá»¯a theo chiá»u ngang vÃ  cÃ¡ch trÃªn 100px */
            text-align: center;
            /* CÄƒn giá»¯a ná»™i dung bÃªn trong */
        }

        #input-pass .form-label {
            font-size: 14px;
            /* Giáº£m kÃ­ch thÆ°á»›c chá»¯ */
        }

        #input-pass input {
            font-size: 14px;
            /* Giáº£m kÃ­ch thÆ°á»›c input */
            padding: 6px;
        }

        #input-pass button {
            font-size: 14px;
            /* Giáº£m kÃ­ch thÆ°á»›c nÃºt */
            padding: 8px;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container mt-4">
        <h2 class="text-center mb-4">ğŸ“Œ Ghi chÃº thá»i gian thá»±c</h2>

        <div class="card p-4 shadow" id="input-pass">
            <div class="mb-3">
                <label for="password" class="form-label">ğŸ”‘ Nháº­p Password:</label>
                <input type="text" id="password" class="form-control">
            </div>
            <button class="btn btn-primary w-100" onclick="fetchNote()">ğŸ” Xem Ghi ChÃº</button>

            <button class="btn btn-success w-100 mt-5" onclick="fetchNotePerson()">ğŸ” Xem Ghi ChÃº CÃ¡ nhÃ¢n</button>

        </div>

        <input type="hidden" id="note-id">

        <div id="notes-container" class="mt-4" style="display: none;">
            <div class="row">
                <div class="col-12 col-md-4">
                    <div class="card p-4 shadow">
                        <h3 id="note-title" class="text-primary">ğŸ“ Ghi chÃº: KhÃ´ng cÃ³ tiÃªu Ä‘á»</h3>
                        <p id="note-edit"></p>
                        <p><strong>ğŸ“‚ Thá»ƒ loáº¡i:</strong> <span id="note-category">KhÃ´ng cÃ³</span></p>
                        <p><strong>ğŸ·ï¸ Tags:</strong> <span id="note-tags">KhÃ´ng cÃ³</span></p>
                        <p><strong>ğŸ“… NgÃ y táº¡o:</strong> <span id="note-created">KhÃ´ng rÃµ</span></p>
                    </div>
                </div>
                <div class="col-6 col-md-8">
                    <div class="card p-4 shadow">
                        <div class="mt-3">
                            <button id="edit-button" class="btn btn-warning" onclick="toggleEdit()">âœï¸ Chá»‰nh
                                sá»­a</button>
                            <button id="save-button" class="btn btn-success" onclick="saveEdit()"
                                style="display: none;">ğŸ’¾
                                LÆ°u</button>
                        </div>
                        <textarea id="note-content" class="form-control mt-2" rows="4"
                            readonly>ChÆ°a cÃ³ ná»™i dung</textarea>
                        <h1>áº¢nh Ä‘Ã­nh kÃ¨m</h1>
                        <div id="image-container" class="row mt-3"></div> <!-- Chá»— Ä‘á»ƒ hiá»ƒn thá»‹ áº£nh -->
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        const socket = io('http://localhost:3000');
        let isEditing = false;

        function fetchNote() {
            const noteId = document.getElementById('note-id').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!noteId) {
                alert("Vui lÃ²ng nháº­p Note ID!");
                return;
            }

            socket.emit('request_note', { noteId, password });

        }

        function fetchNotePerson() {
            const noteId = document.getElementById('note-id').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!noteId) {
                alert("Vui lÃ²ng nháº­p Note ID!");
                return;
            }


            socket.emit('request_note_person', { noteId, password });
        }




        socket.on('load_note', (noteData) => {
            console.log("ğŸ“œ Dá»¯ liá»‡u ghi chÃº nháº­n Ä‘Æ°á»£c:", noteData);

            if (!noteData || typeof noteData !== 'object') {
                document.getElementById('note-content').value = "Lá»—i dá»¯ liá»‡u!";
                return;
            }

            if (noteData.permission == 'edit') {
                document.getElementById('note-edit').innerHTML = "âœï¸<strong>ÄÆ°á»£c phÃ©p edit</strong>";
            } else {
                document.getElementById('note-edit').innerHTML = "ğŸ‘ï¸ <strong>Chá»‰ Ä‘Æ°á»£c phÃ©p Ä‘á»c</strong>";
                document.getElementById("edit-button").style.visibility = "hidden";
            }

            if (noteData && noteData.message) {
                const mess = noteData.message.trim();
                alert(mess);

                if (noteData.error || mess === "Máº­t kháº©u khÃ´ng Ä‘Ãºng hoáº·c ghi chÃº khÃ´ng tá»“n táº¡i.jhjj") {
                    document.getElementById('input-pass').style.display = "block";
                    document.getElementById('notes-container').style.display = "none";

                } else {
                    document.getElementById('notes-container').style.display = "block";
                    document.getElementById('input-pass').style.display = "none";
                }
            }



            document.getElementById('note-title').innerText = `ğŸ“ Ghi chÃº: ${noteData.title || "KhÃ´ng cÃ³ tiÃªu Ä‘á»"}`;
            document.getElementById('note-content').value = noteData.content || "KhÃ´ng cÃ³ ná»™i dung";
            document.getElementById('note-category').innerText = noteData.category || "KhÃ´ng cÃ³";
            document.getElementById('note-tags').innerText = noteData.tags || "KhÃ´ng cÃ³";
            document.getElementById('note-created').innerText = noteData.created_at || "KhÃ´ng rÃµ";

            const imageContainer = document.getElementById("image-container");
            imageContainer.innerHTML = ""; // XÃ³a áº£nh cÅ© trÆ°á»›c khi hiá»ƒn thá»‹ áº£nh má»›i

            try {
                let images = noteData.image;
                if (typeof images === 'string') {
                    images = JSON.parse(images);
                }

                console.log("ğŸ“¸ Danh sÃ¡ch áº£nh:", images);

                if (Array.isArray(images) && images.length > 0) {
                    images.forEach(imgSrc => {
                        if (imgSrc) {
                            const imgElement = document.createElement("img");
                            imgElement.src = `http://localhost/note_management/api/${imgSrc}`;
                            imgElement.classList.add("img-fluid", "rounded", "shadow-sm");
                            imgElement.style.width = "100%";
                            imgElement.style.marginBottom = "10px";

                            const col = document.createElement("div");
                            col.classList.add("col-md-3");
                            col.appendChild(imgElement);
                            imageContainer.appendChild(col);
                        }
                    });
                } else {
                    imageContainer.innerHTML = "<p class='text-muted'>KhÃ´ng cÃ³ áº£nh</p>";
                }
            } catch (error) {
                console.error("âŒ Lá»—i khi xá»­ lÃ½ áº£nh:", error);
                imageContainer.innerHTML = "<p class='text-danger'>Lá»—i khi táº£i áº£nh</p>";
            }
        });

        function toggleEdit() {
            const textArea = document.getElementById('note-content');
            const editButton = document.getElementById('edit-button');
            const saveButton = document.getElementById('save-button');

            if (!isEditing) {
                textArea.removeAttribute('readonly');
                textArea.focus();
                editButton.style.display = 'none';
                saveButton.style.display = 'inline-block';
                isEditing = true;
            }
        }

        function saveEdit() {
            const noteId = document.getElementById('note-id').value.trim();
            const password = document.getElementById('password').value.trim();
            const content = document.getElementById('note-content').value.trim();

            if (!noteId || !password) {
                alert("Thiáº¿u thÃ´ng tin Ä‘á»ƒ lÆ°u!");
                return;
            }

            socket.emit('edit_note', { noteId, password, content });

            document.getElementById('note-content').setAttribute('readonly', true);
            document.getElementById('edit-button').style.display = 'inline-block';
            document.getElementById('save-button').style.display = 'none';
            isEditing = false;
        }

        socket.on('note_updated', (data) => {
            if (data.noteId === document.getElementById('note-id').value.trim()) {
                document.getElementById('note-content').value = data.content;
            }
        });

        const params = new URLSearchParams(window.location.search);
        const note_id = params.get("note_id");

        if (note_id) {
            document.getElementById("note-id").value = note_id;
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>